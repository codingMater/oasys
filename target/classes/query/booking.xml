<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.oasys.common.booking.dao.BookingDao">
	
	<!-- sql 정의 -->
	<sql id="bookingSearch">
		<if test="search == 'b_num'">
			<![CDATA[ b_num LIKE '%' || #{keyword} ||'%' ]]>
		</if>
		<if test="search == 'b_name'">
			<![CDATA[ b_name LIKE '%' || #{keyword} ||'%' ]]>
		</if>
	</sql>
	
	
	
	<!--  리스트 조회 -->
	<select id="bookingList" parameterType="booking" resultType="booking">		
		<![CDATA[
		SELECT
			b_num, to_char(b_date, 'YYYY-MM-DD') as b_date, to_char(b_indate, 'YYYY-MM-DD') as b_indate, to_char(b_outdate, 'YYYY-MM-DD') as b_outdate, b_ismember, b_name, b_phone, b_email, b_payment, b_state, m_no, rg_grade,r_number
		FROM (
				select /*+ INDEX_DESC(booking booking_pk)*/
					rownum as rnum, b_num, b_date, b_indate, b_outdate, b_ismember, b_name, b_phone, b_email, b_payment, b_state, m_no, rg_grade,r_number
				FROM booking
				WHERE]]>
				<trim prefix="(" suffix=") AND " prefixOverrides="AND">
					<include refid="bookingSearch"></include>
				</trim>
				<![CDATA[ rownum <= #{pageNum} * #{amount}
			) bookList
			WHERE rnum > (#{pageNum} - 1) * #{amount}
			]]>
	</select>	
	
	<!--  전체 레코드 조회 -->
	<select id="bookingListCnt" parameterType="booking" resultType="int">
		SELECT count(*) FROM booking
	</select>
	
	<!-- 상세페이지를 위한 게시물 조회 -->
	<select id="bookingDetail" parameterType="int" resultType="booking">
		SELECT
			b_num, to_char(b_date, 'YYYY-MM-DD') as b_date, to_char(b_indate, 'YYYY-MM-DD') as b_indate, to_char(b_outdate, 'YYYY-MM-DD') as b_outdate, b_ismember, b_name, b_phone, b_email, b_payment, b_state, m_no, rg_grade, r_number
		FROM booking
		WHERE b_num = #{b_num}	
	</select>
	
	<!-- 회원 상세 페이지 예약내역 조회 -->
	<select id="memberBookingList" parameterType="int" resultType="booking">		
		<![CDATA[
		SELECT
			b_num, to_char(b_date, 'YYYY-MM-DD') as b_date, b_indate, b_outdate, b_ismember, b_name, b_phone, b_email, b_payment, b_state, m_no, rg_grade,r_number
		FROM booking
		WHERE m_no=#{m_no}
			]]>
	</select>	
	
	
	<!-- 데이터 삭제 -->
	<delete id="bookingDelete" parameterType="booking">
		DELETE FROM booking WHERE b_num = #{b_num}
	</delete>
	
    <update id="bookingUpdate" parameterType="booking">
		UPDATE booking
			SET  b_date = #{b_date}
				,b_indate = sysdate
				,b_outdate = #{b_outdate}
				,rg_grade = #{rg_grade}
				,b_payment = #{b_payment}
				,b_state = #{b_state}
			WHERE b_num = #{b_num}	
	</update>
	
	<!-- 예약 가능한 방 조회 -->
	<select id="roomList" parameterType="booking" resultType="booking">
		SELECT  rg_grade, count(*) as b_roomcnt, rg_price 
		FROM (select r.* , rg.rg_price from room r inner join roomgrade rg on r.rg_grade = rg.rg_grade 
			  WHERE r_number 
			  NOT IN 
			  <![CDATA[	
			  	(select r_number 
			     FROM booking where b_indate<= #{b_indate} and #{b_indate} <b_outdate or b_indate<=#{b_outdate} and #{b_outdate}<b_outdate))
		GROUP BY rg_grade, rg_price having count(*) >= #{b_roomcnt} order by rg_grade
		]]>
	</select>
	
	<!-- 예약 상세페이지 -->
	<select id="bookingClientDetail" parameterType="booking" resultType="booking">
		SELECT rg_grade, rg_price, image1 from roomgrade
		WHERE rg_grade = #{rg_grade}
	</select>
	
	<!--  랜덤 호수 뽑기 -->
	<select id="randomcnt" parameterType="booking" resultType="int">
		select  r_number 
		from 
		(select r.* , rg.rg_price from room r inner join roomgrade rg on r.rg_grade = rg.rg_grade 
		where r_number not in 
		<![CDATA[
		(select r_number 
			     FROM booking where b_indate<= #{b_indate} and #{b_indate} <b_outdate or b_indate<=#{b_outdate} and #{b_outdate}<b_outdate) 
			     order by DBMS_RANDOM.RANDOM)
		where rg_grade=#{rg_grade} and rownum<=#{b_roomcnt}
		]]>
	</select>
	
	<!-- 예약번호 배부 -->
	<select id="bookingNum" resultType="int">
		select booking_seq.nextval from dual
	</select>
	
	<!-- 예약 인서트 -->
	<insert id="bookingInsert" parameterType="booking">
		INSERT INTO booking(b_num, b_indate, b_outdate, b_ismember, b_name, b_phone, b_email, b_payment, m_no, rg_grade, r_number, b_persons)
		VALUES(#{b_num},#{b_indate}, #{b_outdate}, #{b_ismember}, #{b_name}, #{b_phone}, #{b_email}, #{b_payment}, #{m_no}, #{rg_grade}, #{r_number}, #{b_persons})
	</insert>
	
</mapper>